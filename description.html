<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,1:ImageSprite,2:LinkList;/Areas/Epx/Themes/WindowsAzure/Content:0,/Areas/Epx/Themes/WindowsAzure/Content/SpriteImages:1,/Areas/Epx/Themes/Base/Content:2&amp;amp;hashKey=CCA529A7D95F51996C70B60AA6D40289" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/792d7265-3fa9-488a-ab95-8ae7896b31ceCombined.css,1:ImageSprite,2:LinkList,2:SelectLocaleFromPopUp;/Areas/Epx/Themes/WindowsAzure/Content:0,/Areas/Epx/Themes/WindowsAzure/Content/SpriteImages:1,/Areas/Epx/Themes/Base/Content:2&amp;amp;hashKey=AB7D04457C9289CE30F3302613C00319" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Service Bus Durable Message Sender</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" /><link href="description/75f14a81-362b-4f81-a6d8-6cd14071127eBrand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Service Bus Durable Message Sender</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Microsoft Azure, Service Bus
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Service Bus, Message Queuing (MSMQ), Distributed Transaction (DTC), Handling of connectivity faults
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop, Cloud
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">8/1/2014</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/windowsazure/Service-Bus-Durable-Sender-0763230d">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Introduction</h1>
<div><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">This sample demonstrates how an application that is temporarily disconnected from the network can continue to send messages to Service Bus. The durable message sender library
 stores all messages in a local MSMQ queue until connectivity is restored. At the same time, the library allows the application to send message to Service Bus as part of a distributed transaction.</span></div>
<h1><span>Building the Sample</span></h1>
<ul>
<li><span style="font-size:small"><span style="font-family:Calibri">Install Windows Azure SDK&nbsp;2.0 or later.</span></span>
</li><li><span style="font-size:small"><span style="font-family:Calibri">Create a Service Bus namespace.</span></span>
</li><li><span style="font-size:small"><span style="font-family:Calibri">Build the sample. Open the solution in Visual Studio 2010 or later, add your namespace name and SAS key,&nbsp;and press F6.</span></span>
</li><li><span style="font-family:Calibri; font-size:small">To demonstrate the use of DTC, assign a valid SQL connection string to
</span><span style="color:blue; line-height:115%; font-family:Consolas; font-size:9.5pt">private</span><span style="line-height:115%; font-family:Consolas; font-size:9.5pt">
<span style="color:blue">const</span> <span style="color:blue">string</span> SqlConnectionString</span><span style="font-family:Calibri"><span style="font-size:small"> in file Client.cs.</span></span>
</li><li><span style="font-family:Calibri; font-size:small">To disable the fault injector, set
</span><span style="color:blue; line-height:115%; font-family:Consolas; font-size:9.5pt">const</span><span style="line-height:115%; font-family:Consolas; font-size:9.5pt">
<span style="color:blue">bool</span> enableFaultInjection</span><span style="font-family:Calibri; font-size:small"> to
</span><span style="color:blue; line-height:115%; font-family:Consolas; font-size:9.5pt">false</span><span style="font-family:Calibri"><span style="font-size:small">.</span></span>
</li><li><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">Run the client. When prompted, supply the namespace name, issuer name and issuer key of your Service Bus namespace.</span>
</li></ul>
<div><span style="font-size:20px; font-weight:bold">Description</span></div>
<div><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">To allow an application to send brokered messages to a Service Bus queue or topic in the absence of network connectivity, these messages need to be stored locally and be
 transmitted to Service Bus in the background after connectivity has been restored. This functionality is implemented by the durable message sender library. Just as it calls methods of the Service Bus client library, the application calls the Send() method
 of the durable message sender library.</span></div>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">// Create a MessagingFactory.
MessagingFactory messagingFactory = MessagingFactory.Create(namespaceUri, tokenProvider);

// Create a durable sender.
DurableMessageSender durableMessageSender = new DurableMessageSender(messagingFactory, SbusQueueName);

// Send message.
BrokeredMessage msg = new BrokeredMessage(&quot;This is a message.&quot;);

durableMessageSender.Send(msg);
</pre>
<div class="preview">
<pre class="csharp"><span class="cs__com">//&nbsp;Create&nbsp;a&nbsp;MessagingFactory.</span>&nbsp;
MessagingFactory&nbsp;messagingFactory&nbsp;=&nbsp;MessagingFactory.Create(namespaceUri,&nbsp;tokenProvider);&nbsp;
&nbsp;
<span class="cs__com">//&nbsp;Create&nbsp;a&nbsp;durable&nbsp;sender.</span>&nbsp;
DurableMessageSender&nbsp;durableMessageSender&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;DurableMessageSender(messagingFactory,&nbsp;SbusQueueName);&nbsp;
&nbsp;
<span class="cs__com">//&nbsp;Send&nbsp;message.</span>&nbsp;
BrokeredMessage&nbsp;msg&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;BrokeredMessage(<span class="cs__string">&quot;This&nbsp;is&nbsp;a&nbsp;message.&quot;</span>);&nbsp;
&nbsp;
durableMessageSender.Send(msg);&nbsp;
</pre>
</div>
</div>
</div>
<div><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">The durable message sender library enqueues all of the application&rsquo;s messages into a local transactional MSMQ queue. In the background, the durable message sender
 library reads these messages from the MSMQ queue and sends them to the Service Bus queue or topic. The durable message sender library maintains one MSMQ queue per Service Bus queue or topic that the application wants to send to.
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">public void Send(BrokeredMessage sbusMessage)
{
    Message msmqMessage = MsmqHelper.PackSbusMessageIntoMsmqMessage(sbusMessage);
    SendtoMsmq(this.msmqQueue, msmqMessage);
}

void SendtoMsmq(MessageQueue msmqQueue, Message msmqMessage)
{
    if (Transaction.Current == null)
    {
        msmqQueue.Send(msmqMessage, MessageQueueTransactionType.Single);
    }
    else
    {
        msmqQueue.Send(msmqMessage, MessageQueueTransactionType.Automatic);
    }
}
</pre>
<div class="preview">
<pre class="js">public&nbsp;<span class="js__operator">void</span>&nbsp;Send(BrokeredMessage&nbsp;sbusMessage)&nbsp;
<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Message&nbsp;msmqMessage&nbsp;=&nbsp;MsmqHelper.PackSbusMessageIntoMsmqMessage(sbusMessage);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;SendtoMsmq(<span class="js__operator">this</span>.msmqQueue,&nbsp;msmqMessage);&nbsp;
<span class="js__brace">}</span>&nbsp;
&nbsp;
<span class="js__operator">void</span>&nbsp;SendtoMsmq(MessageQueue&nbsp;msmqQueue,&nbsp;Message&nbsp;msmqMessage)&nbsp;
<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">if</span>&nbsp;(Transaction.Current&nbsp;==&nbsp;null)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msmqQueue.Send(msmqMessage,&nbsp;MessageQueueTransactionType.Single);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">}</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msmqQueue.Send(msmqMessage,&nbsp;MessageQueueTransactionType.Automatic);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__brace">}</span>&nbsp;
<span class="js__brace">}</span>&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
</span></div>
<div></div>
<p><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">&nbsp;</span></p>
<div></div>
<p><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">&nbsp;</span></p>
<div>If the durable message sender library experiences a temporary failure when sending a message to Service Bus, the durable message sender library waits some time and then tries again. The wait time increases exponentially with every failure. The maximum
 wait time is 60 seconds. After a successful transmission to Service Bus, the wait time is reset to its initial value of 50ms.</div>
<div>If the durable message sender library experiences a permanent failure when sending a message to Service Bus, the message is moved to a MSMQ deadletter queue.</div>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">Message msmqMessage = null;
try
{
    msmqMessage = this.msmqQueue.EndPeek(result);
}
catch (MessageQueueException ex)
{
    if (ex.MessageQueueErrorCode == MessageQueueErrorCode.IOTimeout)
    {
        MsmqPeekBegin();
        return;
    }
}

if (msmqMessage != null)
{
    BrokeredMessage sbusMessage = MsmqHelper.UnpackSbusMessageFromMsmqMessage(msmqMessage);
    // Clone Service Bus message in case we need to deadletter it.
    BrokeredMessage sbusDeadletterMessage = CloneBrokeredMessage(sbusMessage);

    switch (SendMessageToServiceBus(sbusMessage))
    {
        case SendResult.Success: // Message was successfully sent to Service Bus. Remove MSMQ message from MSMQ queue.
            this.msmqQueue.BeginReceive(TimeSpan.FromSeconds(60), null, MsmqOnReceiveComplete);
            break;
        case SendResult.WaitAndRetry: // Service Bus is temporarily unavailable. Wait.
            waitAfterErrorTimer = new Timer(ResumeSendingMessagesToServiceBus, null, timerWaitTimeInMilliseconds, Timeout.Infinite);
            break;
        case SendResult.PermanentFailure: // Permanent error. Deadletter MSMQ message.
            DeadletterMessage(this.clonedMessage);
            this.msmqQueue.BeginReceive(TimeSpan.FromSeconds(60), null, MsmqOnReceiveComplete);
            break;
        }
    }
}</pre>
<div class="preview">
<pre class="csharp">Message&nbsp;msmqMessage&nbsp;=&nbsp;<span class="cs__keyword">null</span>;&nbsp;
<span class="cs__keyword">try</span>&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;msmqMessage&nbsp;=&nbsp;<span class="cs__keyword">this</span>.msmqQueue.EndPeek(result);&nbsp;
}&nbsp;
<span class="cs__keyword">catch</span>&nbsp;(MessageQueueException&nbsp;ex)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(ex.MessageQueueErrorCode&nbsp;==&nbsp;MessageQueueErrorCode.IOTimeout)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MsmqPeekBegin();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">return</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}&nbsp;
&nbsp;
<span class="cs__keyword">if</span>&nbsp;(msmqMessage&nbsp;!=&nbsp;<span class="cs__keyword">null</span>)&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;BrokeredMessage&nbsp;sbusMessage&nbsp;=&nbsp;MsmqHelper.UnpackSbusMessageFromMsmqMessage(msmqMessage);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Clone&nbsp;Service&nbsp;Bus&nbsp;message&nbsp;in&nbsp;case&nbsp;we&nbsp;need&nbsp;to&nbsp;deadletter&nbsp;it.</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;BrokeredMessage&nbsp;sbusDeadletterMessage&nbsp;=&nbsp;CloneBrokeredMessage(sbusMessage);&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">switch</span>&nbsp;(SendMessageToServiceBus(sbusMessage))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">case</span>&nbsp;SendResult.Success:&nbsp;<span class="cs__com">//&nbsp;Message&nbsp;was&nbsp;successfully&nbsp;sent&nbsp;to&nbsp;Service&nbsp;Bus.&nbsp;Remove&nbsp;MSMQ&nbsp;message&nbsp;from&nbsp;MSMQ&nbsp;queue.</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">this</span>.msmqQueue.BeginReceive(TimeSpan.FromSeconds(<span class="cs__number">60</span>),&nbsp;<span class="cs__keyword">null</span>,&nbsp;MsmqOnReceiveComplete);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">break</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">case</span>&nbsp;SendResult.WaitAndRetry:&nbsp;<span class="cs__com">//&nbsp;Service&nbsp;Bus&nbsp;is&nbsp;temporarily&nbsp;unavailable.&nbsp;Wait.</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waitAfterErrorTimer&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;Timer(ResumeSendingMessagesToServiceBus,&nbsp;<span class="cs__keyword">null</span>,&nbsp;timerWaitTimeInMilliseconds,&nbsp;Timeout.Infinite);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">break</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">case</span>&nbsp;SendResult.PermanentFailure:&nbsp;<span class="cs__com">//&nbsp;Permanent&nbsp;error.&nbsp;Deadletter&nbsp;MSMQ&nbsp;message.</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeadletterMessage(<span class="cs__keyword">this</span>.clonedMessage);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">this</span>.msmqQueue.BeginReceive(TimeSpan.FromSeconds(<span class="cs__number">60</span>),&nbsp;<span class="cs__keyword">null</span>,&nbsp;MsmqOnReceiveComplete);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">break</span>;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
}</pre>
</div>
</div>
</div>
<div></div>
<div class="endscriptcode">&nbsp;</div>
<div></div>
<p>&nbsp;</p>
<div></div>
<p>&nbsp;</p>
<div></div>
<div><span style="font-size:small"><span style="font-family:Calibri">Unlike sending messages directly to Service Bus, sending messages to a transactional MSMQ queue can be done as part of a distributed transaction. As such, the durable message sender library
 allows an application to send messages to a Service Bus queue or topic as part of a regular or a distributed transaction.</span></span></div>
<div><span style="font-family:Calibri; font-size:small">The durable message sender library maintains message ordering. This means that the durable message sender library sends messages to Service Bus in the same order with which the application sends the messages
 to the durable message sender library. The durable message sender library maintains ordering in the presence of temporary failures. In order to avoid message duplication, the Service Bus queue or topic has to have duplicate detection enabled (</span><span style="color:#2b91af; line-height:115%; font-family:Consolas; font-size:9.5pt">QueueDescription</span><span style="line-height:115%; font-family:Consolas; font-size:9.5pt">.RequiresDuplicateDetection
 = <span style="color:blue">true</span>;</span><span style="font-family:Calibri"><span style="font-size:small">).</span></span></div>
<div><span style="font-size:small"><span style="font-family:Calibri">Note that the durable message sender library does not honor transactional guarantees of message batches. If the application sends multiple messages to the durable message sender library within
 a single transaction, and then Service Bus returns a permanent error the durable message sender library sends one of these messages to Service Bus, then this message will not be enqueued into the Service Bus queue or topic whereas the other messages will.</span></span></div>
<div><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">Also note that messages don&rsquo;t expire while they are stored in the MSMQ queue. This implementation of the durable message sender library sets the TimeToBeReceived property
 of the MSMQ message to infinite.</span></div>
<h1><span>Source Code Files</span></h1>
<ul>
<li><span style="font-size:small"><span style="font-family:Calibri">Client.cs: Implements a Service Bus client that sends and receives messages to Service Bus using the durable sender library.</span></span>
</li><li><span style="font-size:small"><span style="font-family:Calibri">DurableMessageSender.cs: Implements the durable message sender API. Implements code that converts Service Bus brokered messages to and from MSMQ messages and sends and receives MSMQ messages.</span></span>
</li><li><span style="font-size:small"><span style="font-family:Calibri">MsmqHelper.cs: Implements queue management and message conversion methods.</span></span>
</li><li><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">FaultInjector.cs: Injects various faults that simulate transient and permanent Service Bus faults.</span>
</li></ul>
<h1>More Information</h1>
<div><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:11pt">For more information on Service Bus, see http://msdn.microsoft.com/en-us/library/windowsazure/jj656647.aspx.</span></div>

</div>


    </div>
</body>
</html>
